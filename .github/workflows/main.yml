name: "Midjourney Bot Automation"

on:
  repository_dispatch:
    types: [trigger-midjourney]
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Midjourney prompt'
        required: true
        default: 'beautiful anime fitness girl doing morning yoga'

jobs:
  midjourney:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up job
      run: echo "üöÄ Starting Midjourney automation job"
      
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable xvfb
        
        # Install Python dependencies
        pip install selenium
        
        # Download ChromeDriver using the new method
        CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1-3)
        echo "Chrome version: $CHROME_VERSION"
        
        # Download ChromeDriver from the new location
        wget -O /tmp/chromedriver-linux64.zip "https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
        sudo unzip /tmp/chromedriver-linux64.zip -d /tmp/
        sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Verify installation
        chromedriver --version
        
    - name: Run Midjourney Bot
      env:
        DISPLAY: :99
        PROMPT: ${{ github.event.client_payload.prompt || github.event.inputs.prompt || 'beautiful anime fitness girl doing morning yoga' }}
        DISCORD_EMAIL: ${{ secrets.DISCORD_EMAIL }}
        DISCORD_PASSWORD: ${{ secrets.DISCORD_PASSWORD }}
      run: |
        # Start virtual display
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 3
        
        # Run the bot
        python midjourney_bot.py
        
    - name: Debug Output
      if: always()
      run: |
        echo "Job completed"
        echo "Prompt used: ${{ github.event.client_payload.prompt || github.event.inputs.prompt || 'beautiful anime fitness girl doing morning yoga' }}"
        
    - name: Post Setup Python
      if: always()
      run: echo "‚úÖ Workflow completed"
      
    - name: Post Checkout code
      if: always()
      run: echo "üìÅ Code checkout completed"
